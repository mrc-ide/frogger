<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Developing leapfrog • frogger</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Developing leapfrog">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">frogger</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/development.html">Developing leapfrog</a>
    </li>
    <li>
      <a href="../articles/variables.html">Variable naming conventions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/frogger/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Developing leapfrog</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/frogger/blob/main/vignettes/development.Rmd" class="external-link"><code>vignettes/development.Rmd</code></a></small>
      <div class="hidden name"><code>development.Rmd</code></div>

    </div>

    
    
<p>This vignette details how to make changes and add extensions to
leapfrog. There are some organisation and structural things about
leapfrog which were added to enable different researchers to make
extensions to the model. In a way that we can turn these on or off at
run time to run different variants of the model.</p>
<p>The overall aim of this is to allow researchers to write these model
extensions with as little overhead as possible. If you find something
annoying or difficult, let me know and we can probably try and simplify
it. Or at least document it better.</p>
<div class="section level2">
<h2 id="structure">Structure<a class="anchor" aria-label="anchor" href="#structure"></a>
</h2>
<div class="section level3">
<h3 id="model-variants">Model variants<a class="anchor" aria-label="anchor" href="#model-variants"></a>
</h3>
<p>Leapfrog has a set of <code>ModelVariant</code>s which can be run.
See <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/model_variants.hpp" class="external-link"><code>r-package/inst/include/model_variants.hpp</code></a>
for details of these. Each model variant is a collection of boolean
switches or enums. These are used to turn on or off different parts of
the code when it is run, so that leapfrog can have different extensions
and we can compose these together in any way we want. These model
variants are evaluated at compile time. When you compile the code, there
will be an instance in the compiled binary for each variant your code
will call. This will cause the binary to be larger but we chose to do it
this way because we wanted the speed from the compile-time plymorphism.
We still need to benchmark this to see how much of a gain it actually
gives.</p>
<p>All model functions are templated on the model variant, and any
conditional behaviour based upon the model variant should be written as
an <a href="https://en.cppreference.com/w/cpp/language/if" class="external-link"><code>if constexpr</code></a>.</p>
</div>
<div class="section level3">
<h3 id="model-functions">Model functions<a class="anchor" aria-label="anchor" href="#model-functions"></a>
</h3>
<p>All model functions should have the same signature e.g.</p>
<pre><code>template&lt;typename ModelVariant, typename real_type&gt;
void my_model_function(int proj_step,
                       const Parameters&lt;ModelVariant, real_type&gt; &amp;pars,
                       const State&lt;ModelVariant, real_type&gt; &amp;state_curr,
                       State&lt;ModelVariant, real_type&gt; &amp;state_next,
                       IntermediateData&lt;ModelVariant, real_type&gt; &amp;intermediate) {</code></pre>
<p>To explain what is going on here</p>
<ul>
<li>Templated on <code>ModelVariant</code> - this is used for any
conditional behaviour based upon the variant being run see <a href="#model-variants">Model variants</a> for details.</li>
<li>Templated on <code>real_type</code> - this is used by TMB during
fitting. Under a normal fit this will be a <code>double</code>.</li>
<li>
<code>proj_step</code> - the current time step of the model as an
index, e.g. if running for 1970:2030, this will start at <code>1</code>
and loop to <code>61</code>. Any input data you read based on time step
index should have <code>1970</code> at the first index. Index
<code>1</code> in R and <code>0</code> in C++.</li>
<li>
<code>pars</code> - the parameters for this model, these are
read-only values</li>
<li>
<code>state_curr</code> - the state at the current point in time
i.e. at <code>t = proj_step - 1</code>. This is read-only.</li>
<li>
<code>state_next</code> - the state at the next time point, i.e. at
<code>t = proj_step</code>. This is what we are currently populating
from the previous time step and the parameters.</li>
<li>
<code>intermediate</code> - a palce for storing any data used within
a single time step. Use this as a place to store intermediate values for
use later in your code. This is reset to all 0s at the end of every time
step.</li>
</ul>
<p>Note that after each time step the code will do the following</p>
<ul>
<li>Optionally save out the state see <a href="#state-saving">State
saving</a> section.</li>
<li>Replace <code>state_curr</code> with <code>state_next</code>.</li>
<li>Set new <code>state_next</code> to all 0s.</li>
<li>Set <code>intermediate</code> to all 0s.</li>
</ul>
</div>
<div class="section level3">
<h3 id="state-saving">State saving<a class="anchor" aria-label="anchor" href="#state-saving"></a>
</h3>
<p>Leapfrog runs a top-level loop over the time step. At the end of each
time step, the state is optionally saved out and eventually returned. We
do it this way because it decouples the reporting of the model and each
time step iteration. When you run the model with <code>run_model</code>
you can specify which years you want to output data for. By default it
will output for all time steps, but if say you are only interested in
the last time step. You can return this by running e.g.</p>
<pre><code><span><span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">parameters</span>, <span class="fl">1970</span><span class="op">:</span><span class="fl">2030</span>, <span class="fl">10</span>, <span class="fl">2030</span><span class="op">)</span></span></code></pre>
<p>This time output is managed by the state saver see <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/state_saver.hpp" class="external-link"><code>r-package/inst/include/state_saver.hpp</code></a></p>
</div>
</div>
<div class="section level2">
<h2 id="adding-new-input-output-or-intermediate-data">Adding new input, output or intermediate data<a class="anchor" aria-label="anchor" href="#adding-new-input-output-or-intermediate-data"></a>
</h2>
<p>Leapfrog uses code generation to write the code for wiring up the
input and output data. This is to reduce the number of locations you
need to make changes when you add new input data or return new data from
the model. In short it amounts to:</p>
<ul>
<li>Add new input data - modify <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_input.csv" class="external-link"><code>inst/cpp_generation/model_input.csv</code></a>
and run <a href="https://github.com/mrc-ide/frogger/blob/main/scripts/generate" class="external-link"><code>scripts/generate</code></a>
</li>
<li>Add new model output - modify <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_output.csv" class="external-link"><code>inst/cpp_generation/model_output.csv</code></a>
and run <a href="https://github.com/mrc-ide/frogger/blob/main/scripts/generate" class="external-link"><code>scripts/generate</code></a>
</li>
</ul>
<div class="section level3">
<h3 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h3>
<p>Input data is generated from csv file in <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/model_input.hpp" class="external-link"><code>r-package/inst/include/model_input.hpp</code></a>,
the columns in this file are</p>
<ol style="list-style-type: decimal">
<li>
<code>r_name</code> - The name of the data in R, from either
<code>data</code> or <code>parameters</code> struct passed to
<code>run_model</code>
</li>
<li>
<code>cpp_name</code> - The name of the data in C++, the label you
will use to refer to the data within the leapfrog model. Use a name
which adheres to the naming convention rules in the README.</li>
<li>
<code>type</code> - The type of data, <code>real_type</code> or
<code>int</code>. <code>real_type</code> is a templated type. Under
normal usage it will be a <code>double</code> but is used by TMB for
model fitting.</li>
<li>
<code>input_when</code> - An expression which evaluates to a boolean
to control when this input data is used. For example
<code>ModelVariant::run_child_model</code> to include only in the child
model. If blank, this is always input.</li>
<li>
<code>value</code> - If you want to initialise this data as a
constant value array, enter the value here. Note that if using this
column then no value should be in the <code>r_name</code> column.</li>
<li>
<code>convert_base</code> - Set to <code>TRUE</code> for any array
of indexes, these will be converted from 1-based numbering (for R) to
0-based numbering (for C++).</li>
<li>
<code>dims</code> - The number of dimensions for this input (max
4)</li>
<li>
<code>dim1</code> - The size of the first dimension</li>
<li>
<code>dim2</code> - The size of the second dimension, can by
blank</li>
<li>
<code>dim3</code> - The size of the third dimension, can be
blank</li>
<li>
<code>dim4</code> - The size of the fourth dimension, can be
blank</li>
</ol>
<p>Note that the dims can be any of the state space sizes or
<code>proj_years</code> for the number of years in the projection. See
the <a href="https://mrc-ide.github.io/frogger/#state-space" class="external-link">README</a>
for valid state space sizes.</p>
<p>After making changes to the <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_input.csv" class="external-link"><code>model_input.csv</code></a>,
run the generate script <a href="https://github.com/mrc-ide/frogger/blob/main/scripts/generate" class="external-link"><code>scripts/generate</code></a>.
This update file <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/model_input.hpp" class="external-link"><code>r-package/inst/include/model_input.hpp</code></a>.
Note that this file should never be changed manually as the generate
script will completely rewrite it.</p>
<p>After regenerating the code, rebuild the project and you are ready to
use the new input data in C++.</p>
</div>
<div class="section level3">
<h3 id="model-outputs">Model outputs<a class="anchor" aria-label="anchor" href="#model-outputs"></a>
</h3>
<p>Model outputs are generated in a similar way to inputs. To modify an
existing or add new output update the file
[<code>inst/cpp_generation/model_output.csv</code>](<a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_" class="external-link uri">https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_</a>.
The columns in this file are:</p>
<ol style="list-style-type: decimal">
<li>
<code>r_name</code> - The name of the output in the list output from
<code>run_model</code>
</li>
<li>
<code>cpp_name</code> - The name of the output as it is referred to
in C++</li>
<li>
<code>r_type</code> - The <code>R</code> type mapping function to
use to convert this to an R-type number e.g. <code>REAL</code> to create
a real typed number</li>
<li>
<code>output_when</code> - Conditional expression for when to output
this from the model. For example
<code>ModelVariant::run_child_model</code> to return only from the child
model. If blank, this is always returned.</li>
<li>
<code>dims</code> - The number of dimensions of this output (max
5)</li>
<li>
<code>dim1</code> - The size of the first dimension</li>
<li>
<code>dim2</code> - The size of the second dimension</li>
<li>
<code>dim3</code> - The size of the third dimension</li>
<li>
<code>dim4</code> - The size of the fourth dimension</li>
<li>
<code>dim5</code> - The size of the fifth dimension</li>
</ol>
<p>Note that the dims can be any of the state space sizes or
<code>proj_years</code> for the number of years in the projection. See
the <a href="https://mrc-ide.github.io/frogger/#state-space" class="external-link">README</a>
for valid state space sizes.</p>
</div>
<div class="section level3">
<h3 id="intermediate-data">Intermediate data<a class="anchor" aria-label="anchor" href="#intermediate-data"></a>
</h3>
<p>Intermediate data is used as a place to store The intermediate data
is not handled by code generation as it only requires changes in one
place. You can make modifications by adding new data into the struct in
<a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/types.hpp" class="external-link"><code>r-package/inst/include/types.hpp</code></a>,
making sure to set its default value in the <code>reset</code> function
on the struct.</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-a-new-model-variant">Adding a new model variant<a class="anchor" aria-label="anchor" href="#adding-a-new-model-variant"></a>
</h2>
<p>To add a new variant, requires work over a few areas. There are two
types of model variants at the moment: 1. A flag which turns a section
of code on or off, this will come with additional model inputs and
outputs 1. A flag which changes the dimensions of some model input or
outputs</p>
<p>The required changes will be different depending on if your new
variant is one of the first types, which brings additional input/output
or the second type which does not bring additional data.</p>
<p>To add a new variant. Firstly, in the code generation:</p>
<ol style="list-style-type: decimal">
<li>Add any new input or output data in <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_input.csv" class="external-link"><code>r-package/inst/include/model_input.csv</code></a>
or <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/model_output.csv" class="external-link"><code>r-package/inst/include/model_output.csv</code></a>
</li>
<li>If you have new input data, add a specialism for the new variant
into the state_types template in <a href="https://github.com/mrc-ide/frogger/blob/main/inst/cpp_generation/state_types.hpp.in" class="external-link"><code>inst/cpp_generation/state_types.hpp.in</code></a>
</li>
<li>Run the generate script</li>
</ol>
<p>In the C++ code:</p>
<ol style="list-style-type: decimal">
<li>Add your new variant in <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/model_variants.hpp" class="external-link"><code>r-package/inst/include/model_variants.hpp</code></a>
</li>
<li>Add a struct for the new state space in <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/state_space.hpp" class="external-link"><code>r-package/inst/include/state_space.hpp</code></a>
</li>
<li>If your model has new input data, add parameters for this variant in
<a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/parameters.hpp" class="external-link"><code>r-package/inst/include/parameters.hpp</code></a>.
Parameter types will be generated, you need to add those types to the
appropriate template specialisation</li>
<li>If your model has new output data, add a new specialisation in <a href="https://github.com/mrc-ide/frogger/blob/main/r-package/inst/include/state_saver.hpp" class="external-link"><code>r-package/inst/include/state_saver.hpp</code></a>
</li>
</ol>
<p>You now need to update the R wrapper to be able to call this new
variant:</p>
<ol style="list-style-type: decimal">
<li>In <a href="https://github.com/mrc-ide/frogger/blob/main/R/run_model.R" class="external-link"><code>R/run_model.R</code></a>
add a new flag to the <code>run_model</code> interface for using your
new variant</li>
<li>Update the conditionals to build the <code>model_variant</code>
string based upon your new flag</li>
<li>Add mapping from the string to the model variant struct in Rcpp
wrapper code in <a href="https://github.com/mrc-ide/frogger/blob/main/src/frogger.cpp" class="external-link"><code>src/frogger.cpp</code></a>.
Note use a <code>constexpr</code> for the state space to ensure it is
evaluated at compile time.</li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jeffrey Imai-Eaton, Magdalene Walters, Robert Ashton, Mantra Kusumgar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
